{% extends "_page.html" %}

{% block title %}EverJudge - 题库{% endblock %}

{% block content %}
<div class="space-y-6">
    
    <!-- 搜索栏区域 -->
    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
        <div class="flex flex-col lg:flex-row gap-4">
            
            <!-- 搜索框 -->
            <div class="flex-grow lg:w-1/2">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="搜索题目名称、ID 或关键词..." 
                        class="w-full pl-12 pr-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:border-brand focus:ring-2 focus:ring-brand/20 transition-all outline-none text-slate-700 placeholder-slate-400">
                    <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                </div>
            </div>

            <!-- 难度筛选 -->
            <div class="lg:w-1/4">
                <select id="difficulty-filter" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:border-brand focus:ring-2 focus:ring-brand/20 transition-all outline-none text-slate-700 cursor-pointer">
                    <option value="">全部难度</option>
                    <option value="0-1">入门 (Lv.0-1)</option>
                    <option value="2-3">普及 (Lv.2-3)</option>
                    <option value="4-5">提高 (Lv.4-5)</option>
                    <option value="6-7">省选 (Lv.6-7)</option>
                    <option value="8-9">NOI (Lv.8-9)</option>
                </select>
            </div>

            <!-- 题库选择 -->
            <div class="lg:w-1/4">
                <select id="set-filter" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:border-brand focus:ring-2 focus:ring-brand/20 transition-all outline-none text-slate-700 cursor-pointer">
                    <option value="">全部题库</option>
                    <option value="basic">基础题库</option>
                    <option value="advanced">进阶题库</option>
                    <option value="contest">比赛题库</option>
                </select>
            </div>
        </div>

        <!-- 快速标签 -->
        <div class="flex flex-wrap gap-2 mt-4">
            <button class="quick-tag px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-100 text-slate-600 hover:bg-brand hover:text-white transition-all" data-tag="数组">数组</button>
            <button class="quick-tag px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-100 text-slate-600 hover:bg-brand hover:text-white transition-all" data-tag="字符串">字符串</button>
            <button class="quick-tag px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-100 text-slate-600 hover:bg-brand hover:text-white transition-all" data-tag="动态规划">动态规划</button>
            <button class="quick-tag px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-100 text-slate-600 hover:bg-brand hover:text-white transition-all" data-tag="图论">图论</button>
            <button class="quick-tag px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-100 text-slate-600 hover:bg-brand hover:text-white transition-all" data-tag="数学">数学</button>
            <button class="quick-tag px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-100 text-slate-600 hover:bg-brand hover:text-white transition-all" data-tag="搜索">搜索</button>
        </div>
    </div>

    <!-- 题目统计信息 -->
    <div class="flex items-center justify-between text-sm text-slate-500">
        <span>共找到 <span id="total-count" class="font-bold text-brand">{{ total_problems }}</span> 道题目</span>
        <div class="flex items-center gap-4">
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="show-solved" class="w-4 h-4 rounded border-slate-300 text-brand focus:ring-brand">
                <span>只看已解决</span>
            </label>
            <select id="sort-by" class="px-3 py-1.5 rounded-lg bg-slate-50 border border-slate-200 text-slate-600 text-sm cursor-pointer">
                <option value="id">按 ID 排序</option>
                <option value="difficulty">按难度排序</option>
                <option value="acceptance">通过率排序</option>
            </select>
        </div>
    </div>

    <!-- 题目列表 -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
        <!-- 表头 -->
        <div class="hidden md:grid md:grid-cols-12 gap-4 px-6 py-4 bg-slate-50 border-b border-slate-100 text-xs font-semibold text-slate-500 uppercase tracking-wider">
            <div class="col-span-1">ID</div>
            <div class="col-span-4">题目名称</div>
            <div class="col-span-2">难度</div>
            <div class="col-span-2">通过率</div>
            <div class="col-span-3">标签</div>
        </div>

        <!-- 题目项 -->
        <div id="problems-list" class="divide-y divide-slate-100">
            {% for problem in problems %}
            <a href="/problems/{{ problem.id }}" class="block group hover:bg-brand-bg/30 transition-colors">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 px-6 py-4 items-center">
                    
                    <!-- ID -->
                    <div class="col-span-1">
                        <span class="font-mono font-bold text-slate-400 group-hover:text-brand transition-colors">#{{ problem.id }}</span>
                    </div>

                    <!-- 题目名称 -->
                    <div class="col-span-4">
                        <h3 class="font-bold text-slate-700 group-hover:text-brand transition-colors flex items-center gap-2">
                            {{ problem.title }}
                            {% if problem.is_new %}
                                <span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-600">NEW</span>
                            {% endif %}
                        </h3>
                        <p class="text-xs text-slate-400 mt-1 md:hidden">{{ problem.acceptance_rate }}% AC</p>
                    </div>

                    <!-- 难度 -->
                    <div class="col-span-2">
                        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg text-xs font-bold
                            {% if problem.difficulty <= 1 %}bg-green-100 text-green-600
                            {% elif problem.difficulty <= 3 %}bg-emerald-100 text-emerald-600
                            {% elif problem.difficulty <= 5 %}bg-yellow-100 text-yellow-600
                            {% elif problem.difficulty <= 7 %}bg-orange-100 text-orange-600
                            {% else %}bg-red-100 text-red-600{% endif %}">
                            <i class="fa-solid fa-signal text-[10px]"></i>
                            Lv.{{ problem.difficulty }}
                        </span>
                    </div>

                    <!-- 通过率 -->
                    <div class="col-span-2">
                        <div class="flex items-center gap-2">
                            <div class="flex-grow h-2 bg-slate-100 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-brand to-brand-dark rounded-full transition-all duration-500" 
                                    style="width: {{ problem.acceptance_rate }}%"></div>
                            </div>
                            <span class="text-xs font-semibold text-slate-600 w-12 text-right">{{ problem.acceptance_rate }}%</span>
                        </div>
                    </div>

                    <!-- 标签 -->
                    <div class="col-span-3">
                        <div class="flex flex-wrap gap-1.5">
                            {% for tag in problem.tags[:3] %}
                            <span class="px-2 py-0.5 rounded-md text-[10px] font-medium bg-slate-100 text-slate-500 group-hover:bg-brand/10 group-hover:text-brand transition-colors">
                                {{ tag }}
                            </span>
                            {% endfor %}
                            {% if problem.tags|length > 3 %}
                                <span class="px-2 py-0.5 rounded-md text-[10px] font-medium bg-slate-100 text-slate-400">
                                    +{{ problem.tags|length - 3 }}
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </a>
            {% else %}
            <div class="text-center py-16 text-slate-400">
                <i class="fa-regular fa-folder-open text-4xl mb-3"></i>
                <p class="text-lg">没有找到符合条件的题目</p>
                <p class="text-sm mt-1">试试调整搜索条件吧</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- 分页控件 -->
    {% if total_pages > 1 %}
    <div class="flex items-center justify-center gap-2">
        <button id="prev-page" class="px-4 py-2 rounded-lg bg-white border border-slate-200 text-slate-600 hover:border-brand hover:text-brand transition-all disabled:opacity-50 disabled:cursor-not-allowed" 
            {% if current_page == 1 %}disabled{% endif %}>
            <i class="fa-solid fa-chevron-left"></i>
        </button>

        <div id="page-numbers" class="flex items-center gap-1">
            {% for page in page_numbers %}
                {% if page == '...' %}
                    <span class="px-3 py-2 text-slate-400">...</span>
                {% elif page == current_page %}
                    <button class="px-4 py-2 rounded-lg bg-brand text-white font-bold">{{ page }}</button>
                {% else %}
                    <button class="page-btn px-4 py-2 rounded-lg bg-white border border-slate-200 text-slate-600 hover:border-brand hover:text-brand transition-all" data-page="{{ page }}">{{ page }}</button>
                {% endif %}
            {% endfor %}
        </div>

        <button id="next-page" class="px-4 py-2 rounded-lg bg-white border border-slate-200 text-slate-600 hover:border-brand hover:text-brand transition-all disabled:opacity-50 disabled:cursor-not-allowed" 
            {% if current_page == total_pages %}disabled{% endif %}>
            <i class="fa-solid fa-chevron-right"></i>
        </button>
    </div>
    {% endif %}
</div>

<script>
$(document).ready(function() {
    let currentPage = {{ current_page }};
    let totalPages = {{ total_pages }};
    let searchTimeout;

    // 搜索输入防抖
    $('#search-input').on('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            performSearch();
        }, 300);
    });

    // 筛选条件变化
    $('#difficulty-filter, #set-filter, #show-solved, #sort-by').on('change', function() {
        performSearch();
    });

    // 快速标签点击
    $('.quick-tag').on('click', function() {
        const tag = $(this).data('tag');
        const currentSearch = $('#search-input').val();
        
        if (currentSearch.includes(tag)) {
            $('#search-input').val(currentSearch.replace(tag, '').trim());
        } else {
            $('#search-input').val(currentSearch ? currentSearch + ' ' + tag : tag);
        }
        
        $(this).toggleClass('bg-brand text-white');
        performSearch();
    });

    // 分页点击
    $('.page-btn').on('click', function() {
        const page = $(this).data('page');
        goToPage(page);
    });

    $('#prev-page').on('click', function() {
        if (currentPage > 1) {
            goToPage(currentPage - 1);
        }
    });

    $('#next-page').on('click', function() {
        if (currentPage < totalPages) {
            goToPage(currentPage + 1);
        }
    });

    // 执行搜索
    function performSearch() {
        const search = $('#search-input').val();
        const difficulty = $('#difficulty-filter').val();
        const set = $('#set-filter').val();
        const showSolved = $('#show-solved').is(':checked');
        const sortBy = $('#sort-by').val();

        const params = new URLSearchParams();
        if (search) params.append('search', search);
        if (difficulty) params.append('difficulty', difficulty);
        if (set) params.append('set', set);
        if (showSolved) params.append('solved', 'true');
        if (sortBy) params.append('sort', sortBy);
        params.append('page', '1');

        window.location.href = '/problems?' + params.toString();
    }

    // 跳转页面
    function goToPage(page) {
        const search = $('#search-input').val();
        const difficulty = $('#difficulty-filter').val();
        const set = $('#set-filter').val();
        const showSolved = $('#show-solved').is(':checked');
        const sortBy = $('#sort-by').val();

        const params = new URLSearchParams();
        if (search) params.append('search', search);
        if (difficulty) params.append('difficulty', difficulty);
        if (set) params.append('set', set);
        if (showSolved) params.append('solved', 'true');
        if (sortBy) params.append('sort', sortBy);
        params.append('page', page);

        window.location.href = '/problems?' + params.toString();
    }
});
</script>
{% endblock %}
